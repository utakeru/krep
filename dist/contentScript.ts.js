const h=(e,n)=>{const t=e.createRange();t.selectNodeContents(n),t.collapse(!1);const c=e.getSelection();c==null||c.removeAllRanges(),c==null||c.addRange(t)},k=()=>{const e=document.createElement("div");return e.className="krep-popup",e.innerText="text",e.style.position="absolute",e.style.display="none",e},b=e=>{const n=document.createElement("a");return n.href=e,n.innerHTML="\u{1F4AC}",n.className="reply-link-button",n},g=()=>{const e=document.createElement("li"),n=document.createElement("a");return n.className="ocean-ui-comments-commentbase-krep",n.style.userSelect="none",n.innerHTML="\u{1F4AC}\u30EA\u30F3\u30AF\u4ED8\u304D\u3067\u8FD4\u4FE1",e.appendChild(n),e},C=(e,n,t)=>{var u,s;const c=e.querySelector(".ocean-ui-comments-commentbase-actions"),o=g(),r=(s=(u=e.querySelector(".ocean-ui-comments-commentbase-time a"))==null?void 0:u.attributes.getNamedItem("href"))==null?void 0:s.value;o.addEventListener("click",()=>t(e,n,r)),c.querySelector(".ocean-ui-comments-commentbase-krep")||c.appendChild(o)},E=(e,n)=>{if(console.log({comment:e,parentPost:n}),e)return e;if(n){const t=n.querySelector(".ocean-ui-comments-post-morecomment");if(!t)return null;if(t.style.display!=="none"){const c=document.querySelector(".krep-popup");c.style.display="none",window.confirm("\u30B3\u30E1\u30F3\u30C8\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\u3002\u53E4\u3044\u30B3\u30E1\u30F3\u30C8\u3092\u5C55\u958B\u3057\u307E\u3059\u304B\uFF1F")&&t.click()}else return"\u30B3\u30E1\u30F3\u30C8\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\u3002\u524A\u9664\u3055\u308C\u305F\u304B\u3001\u5225\u306A\u5834\u6240\u306B\u3042\u308B\u53EF\u80FD\u6027\u304C\u3042\u308A\u307E\u3059\u3002";return null}return null},L=e=>{let n=e.querySelector(".ocean-ui-editor-field");return n.tagName.toLowerCase()==="iframe"?new Promise(t=>{n.addEventListener("load",()=>{t([n.ownerDocument,n.ownerDocument.querySelector(".editable")])},{once:!0})}):Promise.resolve([document,n])},w=(e,n)=>{const t=b(e);n.innerHTML=t.outerHTML+"<span>&nbsp;</span>"+(n.innerHTML==="<br>"?"":n.innerHTML)},y=e=>{const n=document.querySelector("#contents-body-ocean");if(!n)return null;Array.from(document.querySelectorAll(".ocean-ui-comments-commentbase-entity")).forEach(o=>{e.forEach(r=>r(o))});const t=new MutationObserver(()=>{const o=document.querySelector(".ocean-ui-comments-commentcomponent");o&&(Array.from(document.querySelectorAll(".ocean-ui-comments-commentbase-entity")).forEach(r=>{e.forEach(u=>u(r))}),c.observe(o,{childList:!0,subtree:!0}),t.disconnect())}),c=new MutationObserver(o=>{o.forEach(r=>{if(!(r.target instanceof Element))return;const u=r.target.classList;(u.contains("ocean-ui-comments-commentcomponent")||u.contains("ocean-ui-comments-post-commentholder"))&&r.addedNodes.forEach(s=>{s instanceof Element&&(e.forEach(l=>l(s)),Array.from(s.querySelectorAll(".ocean-ui-comments-commentbase-entity")).forEach(l=>{e.forEach(a=>a(l))}))})})});return t.observe(n,{childList:!0,subtree:!0}),c},f=(e,n)=>{const t=document.querySelector(".krep-popup");t.style.display="block",t.style.left=e.pageX-t.clientWidth>0?e.pageX-t.clientWidth+"px":"0px",t.style.top=e.pageY-t.clientHeight*1.2+"px",t.innerHTML=n!=null?n:""},S=(e,n,t)=>{e.addEventListener("mouseover",c=>{console.log(c.target);const o=v(c.target.href);console.log("linkToComment[normalizedLink]",t[o]),console.log({linkToComment:t},{normalizedLink:o});const r=t[o];n?f(c,E(r,n)):f(c,E(r,void 0))}),e.addEventListener("mouseout",()=>{const c=document.querySelector(".krep-popup");c.style.display="none"})},v=e=>e.replace(/^(https:\/\/\w+)\.s\./,"$1."),A=e=>{const n=new URL(e),t=n.href.replace(n.origin,"");return[/^\/k\/#\/people\/user\/.+/,/^\/k\/#\/space\/[0-9]+\/thread\/.+/,/^\/k\/guest\/[0-9]+\/#\/space\/[0-9]+\/thread\/[0-9]+/,/^\/k\/#\/ntf\/.+\/k\/space\/.+/,/^\/k\/#\/ntf\/.+\/k\/people\/.+/].some(o=>o.test(t))};let i;(()=>{const e={},n=o=>{var a,m,p,d;const r=(a=o.querySelector(".ocean-ui-comments-commentbase-name"))==null?void 0:a.innerText,u=o.querySelector(".ocean-ui-comments-commentbase-usericon"),s=(m=o.querySelector(".ocean-ui-comments-commentbase-contents"))==null?void 0:m.innerHTML,l=(d=(p=o.querySelector(".ocean-ui-comments-commentbase-time a"))==null?void 0:p.attributes.getNamedItem("href"))==null?void 0:d.value;console.log({href:l}),l&&(e[l]=u.outerHTML+r+s)};document.body.appendChild(k());const t=(o,r,u)=>{o.querySelector(".ocean-ui-comments-commentbase-comment").click(),L(r).then(([l,a])=>{u&&w(u,a),h(l,a)})},c=o=>{const r=o.closest(".ocean-ui-comments-post");if(!r)throw new Error("unexpected error");C(o,r,t),n(o);const u=o.querySelector(".user-token-reply-link-button");u&&S(u,r,e)};window.addEventListener("hashchange",o=>{i==null||i.disconnect(),console.log(o.newURL),window.dispatchEvent(new CustomEvent("krep::urlChange",{detail:{}}))}),y([c]),window.addEventListener("krep::urlEnableFetched",()=>{console.log("krep::urlEnableFetched",new Date),i=y([c])}),window.addEventListener("krep::urlChange",()=>{console.log("urlChange"),A(location.href)&&window.dispatchEvent(new CustomEvent("krep::urlEnableFetched"))})})();
