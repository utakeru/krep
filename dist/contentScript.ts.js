const h=(e,t)=>{const n=e.createRange();n.selectNodeContents(t),n.collapse(!1);const c=e.getSelection();c==null||c.removeAllRanges(),c==null||c.addRange(n)},k=()=>{const e=document.createElement("div");return e.className="krep-popup",e.innerText="text",e.style.position="absolute",e.style.display="none",e},b=e=>{const t=document.createElement("a");return t.href=e,t.innerHTML="\u{1F4AC}",t.className="reply-link-button",t},L=()=>{const e=document.createElement("li"),t=document.createElement("a");return t.className="ocean-ui-comments-commentbase-krep",t.style.userSelect="none",t.innerHTML="\u{1F4AC}\u30EA\u30F3\u30AF\u4ED8\u304D\u3067\u8FD4\u4FE1",e.appendChild(t),e},C=(e,t,n)=>{var u,s;const c=e.querySelector(".ocean-ui-comments-commentbase-actions"),o=L(),r=(s=(u=e.querySelector(".ocean-ui-comments-commentbase-time a"))==null?void 0:u.attributes.getNamedItem("href"))==null?void 0:s.value;o.addEventListener("click",()=>n(e,t,r)),c.querySelector(".ocean-ui-comments-commentbase-krep")||c.appendChild(o)},y=(e,t)=>{if(e)return e;if(t){const n=t.querySelector(".ocean-ui-comments-post-morecomment");if(!n)return null;if(n.style.display!=="none"){const c=document.querySelector(".krep-popup");c.style.display="none",window.confirm("\u30B3\u30E1\u30F3\u30C8\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\u3002\u53E4\u3044\u30B3\u30E1\u30F3\u30C8\u3092\u5C55\u958B\u3057\u307E\u3059\u304B\uFF1F")&&n.click()}else return"\u30B3\u30E1\u30F3\u30C8\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\u3002\u524A\u9664\u3055\u308C\u305F\u304B\u3001\u5225\u306A\u5834\u6240\u306B\u3042\u308B\u53EF\u80FD\u6027\u304C\u3042\u308A\u307E\u3059\u3002";return null}return null},g=e=>{let t=e.querySelector(".ocean-ui-editor-field");return t.tagName.toLowerCase()==="iframe"?new Promise(n=>{t.addEventListener("load",()=>{n([t.ownerDocument,t.ownerDocument.querySelector(".editable")])},{once:!0})}):Promise.resolve([document,t])},w=(e,t)=>{const n=b(e);t.innerHTML=n.outerHTML+"<span>&nbsp;</span>"+(t.innerHTML==="<br>"?"":t.innerHTML)},E=e=>{const t=document.querySelector("#contents-body-ocean");if(!t)return null;Array.from(document.querySelectorAll(".ocean-ui-comments-commentbase-entity")).forEach(o=>{e.forEach(r=>r(o))});const n=new MutationObserver(()=>{const o=document.querySelector(".ocean-ui-comments-commentcomponent");o&&(Array.from(document.querySelectorAll(".ocean-ui-comments-commentbase-entity")).forEach(r=>{e.forEach(u=>u(r))}),c.observe(o,{childList:!0,subtree:!0}),n.disconnect())}),c=new MutationObserver(o=>{o.forEach(r=>{if(!(r.target instanceof Element))return;const u=r.target.classList;(u.contains("ocean-ui-comments-commentcomponent")||u.contains("ocean-ui-comments-post-commentholder"))&&r.addedNodes.forEach(s=>{s instanceof Element&&(e.forEach(a=>a(s)),Array.from(s.querySelectorAll(".ocean-ui-comments-commentbase-entity")).forEach(a=>{e.forEach(l=>l(a))}))})})});return n.observe(t,{childList:!0,subtree:!0}),c},f=(e,t)=>{const n=document.querySelector(".krep-popup");n.style.display="block",n.style.left=e.pageX-n.clientWidth>0?e.pageX-n.clientWidth+"px":"0px",n.style.top=e.pageY-n.clientHeight*1.2+"px",n.innerHTML=t!=null?t:""},S=(e,t,n)=>{e.addEventListener("mouseover",c=>{const o=v(c.target.href);console.log("linkToComment[normalizedLink]",n[o]),console.log({linkToComment:n},{normalizedLink:o});const r=n[o];t?f(c,y(r,t)):f(c,y(r,void 0))}),e.addEventListener("mouseout",()=>{const c=document.querySelector(".krep-popup");c.style.display="none"})},v=e=>e.replace(/^(https:\/\/\w+)\.s\./,"$1."),A=e=>{const t=new URL(e),n=t.href.replace(t.origin,"");return[/^\/k\/#\/people\/user\/.+/,/^\/k\/#\/space\/[0-9]+\/thread\/.+/,/^\/k\/guest\/[0-9]+\/#\/space\/[0-9]+\/thread\/[0-9]+/,/^\/k\/#\/ntf\/.+\/k\/space\/.+/,/^\/k\/#\/ntf\/.+\/k\/people\/.+/].some(o=>o.test(n))};let i;(()=>{const e={},t=o=>{var l,m,p,d;const r=(l=o.querySelector(".ocean-ui-comments-commentbase-name"))==null?void 0:l.innerText,u=o.querySelector(".ocean-ui-comments-commentbase-usericon"),s=(m=o.querySelector(".ocean-ui-comments-commentbase-contents"))==null?void 0:m.innerHTML,a=(d=(p=o.querySelector(".ocean-ui-comments-commentbase-time a"))==null?void 0:p.attributes.getNamedItem("href"))==null?void 0:d.value;a&&(e[a]=u.outerHTML+r+s)};document.body.appendChild(k());const n=(o,r,u)=>{o.querySelector(".ocean-ui-comments-commentbase-comment").click(),g(r).then(([a,l])=>{u&&w(u,l),h(a,l)})},c=o=>{const r=o.closest(".ocean-ui-comments-post");if(!r)throw new Error("unexpected error");C(o,r,n),t(o);const u=o.querySelector(".user-token-reply-link-button");u&&S(u,r,e)};window.addEventListener("hashchange",()=>{i==null||i.disconnect(),window.dispatchEvent(new CustomEvent("krep::urlChange",{detail:{}}))}),E([c]),window.addEventListener("krep::urlEnableFetched",()=>{i=E([c])}),window.addEventListener("krep::urlChange",()=>{A(location.href)&&window.dispatchEvent(new CustomEvent("krep::urlEnableFetched"))})})();
